<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sarat Office | Work Place Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }

    .map-controls {
      padding: 10px;
      background: #f5f5f5;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      border-bottom: 1px solid #ddd;
    }

    .map-controls input {
      padding: 8px;
      font-size: 14px;
      width: 200px;
    }

    #map {
      width: 100%;
      height: calc(100vh - 60px);
    }

    #loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      z-index: 1000;
    }

    .error {
      color: red;
      padding: 20px;
      text-align: center;
    }
  </style>
  
  <!-- Load MarkerClusterer CSS (optional) -->
  <link rel="stylesheet" href="https://unpkg.com/@googlemaps/markerclusterer/dist/styles.min.css">
</head>

<body>
  <div id="loading">Loading map...</div>
  
  <div class="map-controls" style="display: none;">
    <input list="blockList" id="blockSearch" placeholder="Type / Select Block Name">
    <datalist id="blockList"></datalist>
    <input type="text" id="codeSearch" placeholder="Search Work Place Code">
    <input type="text" id="nameSearch" placeholder="Search Work Place Name">
  </div>

  <div id="map" style="display: none;"></div>

  <script>
    // Configuration - USE YOUR API KEY HERE
    const GOOGLE_MAPS_API_KEY = 'AIzaSyBg1u41idNFQLOTM2tUR3R2tYdLou2X9Ys';
    const MAP_DATA_URL = 'https://cdn.jsdelivr.net/gh/saratoffice/locations@v1.3/map.js';
    
    // Global variables
    let map;
    let markers = [];
    let markerCluster;
    let allLocations = [];

    // Local fallback data (in case CDN fails)
    const fallbackLocations = [
      {
        name: "Example Office 1",
        lat: 28.6139,
        lng: 77.2090,
        code: "DEL001",
        block: "North Block",
        type: "Office",
        address: "New Delhi, India"
      },
      {
        name: "Example Office 2",
        lat: 19.0760,
        lng: 72.8777,
        code: "MUM001",
        block: "West Block",
        type: "Office",
        address: "Mumbai, India"
      },
      {
        name: "Example Office 3",
        lat: 12.9716,
        lng: 77.5946,
        code: "BLR001",
        block: "South Block",
        type: "Office",
        address: "Bangalore, India"
      }
    ];

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 5,
        center: { lat: 20.5937, lng: 78.9629 }, // Center on India
        mapTypeId: "terrain",
      });

      // Try to load your map.js script
      loadExternalMapScript();
    }

    function loadExternalMapScript() {
      fetch(MAP_DATA_URL)
        .then(response => {
          if (!response.ok) throw new Error('Failed to load data');
          return response.text();
        })
        .then(scriptText => {
          // Extract locations from the script
          const locations = extractLocationsFromScript(scriptText);
          if (locations && locations.length > 0) {
            allLocations = locations;
            addMarkersToMap(allLocations);
            setupControls();
            showMap();
          } else {
            useFallbackData();
          }
        })
        .catch(error => {
          console.error('Error loading external data:', error);
          useFallbackData();
        });
    }

    function extractLocationsFromScript(scriptText) {
      console.log('Parsing script text...');
      
      // Try different patterns to find locations
      const patterns = [
        /locations\s*=\s*(\[[\s\S]*?\])\s*;?/,
        /var\s+locations\s*=\s*(\[[\s\S]*?\])\s*;?/,
        /let\s+locations\s*=\s*(\[[\s\S]*?\])\s*;?/,
        /const\s+locations\s*=\s*(\[[\s\S]*?\])\s*;?/,
        /window\.locations\s*=\s*(\[[\s\S]*?\])\s*;?/
      ];
      
      for (const pattern of patterns) {
        const match = scriptText.match(pattern);
        if (match) {
          try {
            // Clean the string - remove comments and fix common issues
            let jsonStr = match[1]
              .replace(/\/\/.*/g, '') // Remove single line comments
              .replace(/\/\*[\s\S]*?\*\//g, '') // Remove multi-line comments
              .replace(/([{,]\s*)(\w+)(\s*:)/g, '$1"$2"$3') // Add quotes to property names
              .replace(/'/g, '"'); // Replace single quotes with double quotes
            
            // Fix trailing commas
            jsonStr = jsonStr.replace(/,\s*}/g, '}').replace(/,\s*\]/g, ']');
            
            const locations = JSON.parse(jsonStr);
            console.log(`Successfully parsed ${locations.length} locations`);
            return locations;
          } catch (e) {
            console.error('Error parsing JSON:', e);
            console.log('Attempting eval as fallback...');
            try {
              return eval(`(${match[1]})`);
            } catch (e2) {
              console.error('Eval also failed:', e2);
            }
          }
        }
      }
      
      // If no pattern matches, check if the entire file is JSON
      try {
        const locations = JSON.parse(scriptText.trim());
        if (Array.isArray(locations)) {
          console.log(`Parsed ${locations.length} locations as direct JSON`);
          return locations;
        }
      } catch (e) {
        console.log('File is not direct JSON');
      }
      
      return null;
    }

    function addMarkersToMap(locations) {
      // Clear existing markers
      markers.forEach(marker => marker.setMap(null));
      markers = [];
      
      if (markerCluster) {
        markerCluster.clearMarkers();
      }

      locations.forEach(location => {
        const marker = new google.maps.Marker({
          position: { lat: parseFloat(location.lat), lng: parseFloat(location.lng) },
          map: map,
          title: location.name || location.code,
        });

        // Add info window
        const infoWindow = new google.maps.InfoWindow({
          content: `
            <div style="padding: 10px; min-width: 200px;">
              <h3 style="margin: 0 0 10px 0;">${location.name || 'Unnamed Location'}</h3>
              <p><strong>Code:</strong> ${location.code || 'N/A'}</p>
              <p><strong>Block:</strong> ${location.block || 'N/A'}</p>
              <p><strong>Type:</strong> ${location.type || 'N/A'}</p>
              ${location.address ? `<p><strong>Address:</strong> ${location.address}</p>` : ''}
              ${location.website ? `<p><a href="${location.website}" target="_blank">Visit Website</a></p>` : ''}
            </div>
          `
        });

        marker.addListener("click", () => {
          infoWindow.open(map, marker);
        });

        markers.push(marker);
      });

      // Create marker cluster
      markerCluster = new markerClusterer.MarkerClusterer({ 
        map, 
        markers,
        renderer: {
          render: ({ count, position }) => {
            // Custom cluster icon
            return new google.maps.Marker({
              position,
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 10 + Math.min(count, 10),
                fillColor: "#4285F4",
                fillOpacity: 0.8,
                strokeWeight: 2,
                strokeColor: "#FFFFFF"
              },
              label: {
                text: String(count),
                color: "#FFFFFF",
                fontSize: "12px"
              }
            });
          }
        }
      });
      
      // Fit map bounds to show all markers
      if (markers.length > 0) {
        const bounds = new google.maps.LatLngBounds();
        markers.forEach(marker => bounds.extend(marker.getPosition()));
        map.fitBounds(bounds);
        
        // Don't zoom in too much if only one marker
        if (markers.length === 1) {
          google.maps.event.addListenerOnce(map, 'bounds_changed', function() {
            if (this.getZoom() > 15) {
              this.setZoom(15);
            }
          });
        }
      }
    }

    function setupControls() {
      // Populate block list
      const blockList = [...new Set(allLocations.map(loc => loc.block).filter(Boolean))];
      const datalist = document.getElementById('blockList');
      datalist.innerHTML = '';
      blockList.forEach(block => {
        const option = document.createElement('option');
        option.value = block;
        datalist.appendChild(option);
      });

      // Setup search functionality
      document.getElementById('blockSearch').addEventListener('input', filterMarkers);
      document.getElementById('codeSearch').addEventListener('input', filterMarkers);
      document.getElementById('nameSearch').addEventListener('input', filterMarkers);
      
      // Add clear button
      const clearButton = document.createElement('button');
      clearButton.textContent = 'Clear Filters';
      clearButton.style.padding = '8px 16px';
      clearButton.style.cursor = 'pointer';
      clearButton.addEventListener('click', clearFilters);
      document.querySelector('.map-controls').appendChild(clearButton);
    }

    function filterMarkers() {
      const blockQuery = document.getElementById('blockSearch').value.toLowerCase();
      const codeQuery = document.getElementById('codeSearch').value.toLowerCase();
      const nameQuery = document.getElementById('nameSearch').value.toLowerCase();
      
      const filteredLocations = allLocations.filter(location => {
        const matchesBlock = !blockQuery || 
          (location.block && location.block.toLowerCase().includes(blockQuery));
        const matchesCode = !codeQuery || 
          (location.code && location.code.toLowerCase().includes(codeQuery));
        const matchesName = !nameQuery || 
          (location.name && location.name.toLowerCase().includes(nameQuery));
        
        return matchesBlock && matchesCode && matchesName;
      });
      
      addMarkersToMap(filteredLocations);
    }
    
    function clearFilters() {
      document.getElementById('blockSearch').value = '';
      document.getElementById('codeSearch').value = '';
      document.getElementById('nameSearch').value = '';
      addMarkersToMap(allLocations);
    }

    function useFallbackData() {
      console.log('Using fallback data');
      allLocations = fallbackLocations;
      addMarkersToMap(allLocations);
      setupControls();
      showMap();
    }

    function showMap() {
      document.getElementById('loading').style.display = 'none';
      document.querySelector('.map-controls').style.display = 'flex';
      document.getElementById('map').style.display = 'block';
    }

    // Load everything
    function initialize() {
      if (!GOOGLE_MAPS_API_KEY || GOOGLE_MAPS_API_KEY.includes('YOUR_GOOGLE_MAPS_API_KEY_HERE')) {
        document.getElementById('loading').innerHTML = `
          <div class="error">
            <h3>API Key Required</h3>
            <p>Please add your Google Maps API key to the code.</p>
            <p>Get a free API key from: <a href="https://developers.google.com/maps/documentation/javascript/get-api-key" target="_blank">Google Cloud Console</a></p>
          </div>
        `;
        return;
      }

      // Load Google Maps API first
      const gmapScript = document.createElement('script');
      gmapScript.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initMap`;
      gmapScript.async = true;
      gmapScript.defer = true;
      
      // Load MarkerClusterer after Google Maps
      gmapScript.onload = () => {
        const clusterScript = document.createElement('script');
        clusterScript.src = "https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js";
        clusterScript.onload = () => {
          console.log('All scripts loaded successfully');
        };
        document.head.appendChild(clusterScript);
      };
      
      document.head.appendChild(gmapScript);
    }

    // Start when page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initialize);
    } else {
      initialize();
    }
  </script>
</body>
</html>
