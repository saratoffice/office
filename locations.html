<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Workpalce Locations| Sarat Office</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <!-- Common CSS (menu, footer, global styles) -->
  <link rel="stylesheet" href="style.css">
  <!-- ‚úÖ IMPORTANT: site components for header/footer etc. -->
  <script src="assets/Scripts/site-components.js" defer></script>
  <!-- Font Awesome for social media icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
<div id="site-header"></div>
<!-- CONTENT -->
<!-- Container -->
<div class="map-controls">
  <!-- Use a custom focus handler to ensure the dropdown always opens fully -->
  <input id="blockSearch" list="blockList" type="text" placeholder="Type / Select Block Name" onfocus="this.value=''" onchange="this.blur();" />
  <datalist id="blockList"></datalist>
  
  <input id="codeSearch" type="text" placeholder="Search Work Place Code" />
  <input id="nameSearch" type="text"placeholder="Search Work Place Name" />
</div>

<!-- Map height increased from 500px to 600px -->
<div id="map" style="width: 100%; height: 600px; background: #eee; border-radius: 8px;"></div>

<!-- Dynamic Location Counts Container -->
<div id="locationCounts" style="margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px; font-family: Arial, sans-serif; font-size: 14px; border: 1px solid #e0e0e0;">
  <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 25px; margin-bottom: 10px;">
    <span style="font-weight: bold; color: #1976d2;">Total Locations: <span id="totalCount" style="color: #333;">0</span></span>
    <!-- Dynamic categories will be inserted here -->
  </div>
  <div style="text-align: center; font-size: 12px; color: #666; font-style: italic;">
    <span id="filterStatus">Showing all locations</span>
  </div>
</div>

<style>
/* Ensure no horizontal scrolling anywhere */
html, body {
  margin: 0;
  padding: 0;
  overflow-x: hidden;
  width: 100%;
}

/* Make everything respect container width */
* {
  box-sizing: border-box;
  max-width: 100%;
}

/* Main container - assuming there's a container div wrapping the content */
body > *:not(script) {
  width: 100%;
  max-width: 100%;
  padding-left: 15px;
  padding-right: 15px;
  margin-left: auto;
  margin-right: auto;
}

/* For the map controls container */
.map-controls { 
  display: flex; 
  gap: 10px; 
  flex-wrap: wrap; 
  margin-bottom: 15px;
  width: 100%;
  max-width: 100%;
}

.map-controls input { 
  padding: 8px 12px; 
  font-size: 14px; 
  min-width: 200px; 
  flex: 1 1 200px;
  border: 1px solid #ccc; 
  border-radius: 4px; 
  height: 40px;
}

/* Show All button styling */
.map-controls button {
  padding: 8px 16px; 
  font-size: 14px; 
  background: #1976d2; 
  color: white; 
  border: none; 
  border-radius: 4px; 
  cursor: pointer; 
  transition: background 0.3s;
  height: 40px;
  min-width: 100px;
  white-space: nowrap;
}

#map { 
  margin-top: 10px; 
  width: 100%;
  max-width: 100%;
  height: 550px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Prevent Leaflet container overflow (important for GitHub Pages) */
.leaflet-container {
  max-width: 100% !important;
}

/* Animation for marker click */
@keyframes markerPulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.3); }
  100% { transform: scale(1.2); }
}

.marker-clicked {
  animation: markerPulse 0.3s ease-out forwards;
}

/* Category color styles */
.category-total { color: #1976d2; font-weight: bold; }
.category-ppc { color: #d32f2f; font-weight: bold; }
.category-fps { color: #fbc02d; font-weight: bold; }
.category-godown { color: #388e3c; font-weight: bold; }
.category-rice-mill { color: #7b1fa2; font-weight: bold; }
.category-other { color: #455a64; font-weight: bold; }

/* Info window button styles */
.info-window-buttons {
  display: flex;
  gap: 12px;
  margin: 15px 0 10px;
  justify-content: center;
}

.info-window-btn {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  border: none;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  color: white;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.info-window-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

.info-window-btn:active {
  transform: scale(0.95);
}

.share-btn {
  background: #4267B2;
}

.navigate-btn {
  background: #34A853;
}

/* Share Dialog Styles */
.share-dialog-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  animation: fadeIn 0.2s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.share-dialog {
  background: white;
  border-radius: 16px;
  padding: 24px;
  max-width: 400px;
  width: 90%;
  box-shadow: 0 10px 40px rgba(0,0,0,0.2);
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from {
    transform: translateY(50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.share-dialog h3 {
  margin: 0 0 8px 0;
  color: #1976d2;
  font-size: 18px;
}

.share-dialog .location-name {
  color: #666;
  font-size: 14px;
  margin-bottom: 20px;
  padding-bottom: 12px;
  border-bottom: 1px solid #eee;
  word-break: break-word;
}

.share-dialog .coordinates {
  background: #f5f5f5;
  padding: 12px;
  border-radius: 8px;
  font-family: monospace;
  font-size: 13px;
  margin-bottom: 20px;
  word-break: break-all;
  text-align: center;
}

.social-icons {
  display: flex;
  justify-content: center;
  gap: 16px;
  margin: 20px 0;
  flex-wrap: wrap;
}

.social-icon {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 24px;
  text-decoration: none;
  transition: all 0.2s ease;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.social-icon:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

.social-icon:active {
  transform: translateY(0);
}

.social-icon.twitter { background: #1DA1F2; }
.social-icon.facebook { background: #4267B2; }
.social-icon.whatsapp { background: #25D366; }
.social-icon.telegram { background: #0088cc; }
.social-icon.copy { background: #6c757d; }

.close-dialog-btn {
  width: 100%;
  padding: 12px;
  background: #dc3545;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.2s;
  margin-top: 10px;
}

.close-dialog-btn:hover {
  background: #c82333;
}

/* Info window custom styling */
.gm-style-iw {
  padding: 12px !important;
  border-radius: 12px !important;
}

.gm-style-iw-d {
  overflow: hidden !important;
}

.gm-ui-hover-effect {
  display: none !important;
}

/* =========================
   TABLET (768px‚Äì1024px)
   ========================= */
@media (max-width: 1024px) {
  #map {
    height: 500px;
  }
  
  .map-controls input { 
    min-width: 180px;
  }
}

/* =========================
   MOBILE (768px and below)
   ========================= */
@media (max-width: 768px) {
  /* Ensure body has no horizontal scroll */
  body {
    overflow-x: hidden;
    padding-left: 10px;
    padding-right: 10px;
  }

  .map-controls {
    flex-direction: column;
    gap: 8px;
  }

  .map-controls input { 
    min-width: 100%;
    width: 100%;
    flex: none;
  }
  
  .map-controls button {
    width: 100%;
    min-width: 100%;
  }

  #map { 
    height: 450px;
    margin-top: 8px;
  }
  
  #locationCounts {
    padding: 10px !important;
  }
  
  #locationCounts > div:first-child {
    gap: 15px !important;
  }
  
  .social-icon {
    width: 45px;
    height: 45px;
    font-size: 22px;
  }
  
  .share-dialog {
    padding: 20px;
    width: 95%;
  }
}

/* Small mobile devices */
@media (max-width: 480px) {
  .map-controls input,
  .map-controls button {
    font-size: 13px;
    height: 38px;
  }
  
  #map {
    height: 400px;
  }
  
  .social-icon {
    width: 40px;
    height: 40px;
    font-size: 20px;
  }
  
  .social-icons {
    gap: 12px;
  }
  
  .share-dialog h3 {
    font-size: 16px;
  }
  
  .share-dialog .coordinates {
    font-size: 12px;
    padding: 10px;
  }
}

/* Handle very small devices */
@media (max-width: 360px) {
  .social-icons {
    gap: 8px;
  }
  
  .social-icon {
    width: 38px;
    height: 38px;
    font-size: 18px;
  }
}

/* Ensure content doesn't overflow on any device */
img, video, iframe, table, div {
  max-width: 100%;
}

/* Fix for Google Maps info window on mobile */
@media (max-width: 480px) {
  .gm-style-iw-c {
    max-width: 280px !important;
  }
  
  .gm-style-iw-d {
    max-width: 280px !important;
  }
  
  .info-window-btn {
    width: 40px;
    height: 40px;
    font-size: 18px;
  }
}

</style>

<!-- Load Google Maps API with optimized loading parameter -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBg1u41idNFQLOTM2tUR3R2tYdLou2X9Ys&loading=async"></script>

<script>
(function() {
  let map;
  let markers = [];
  const blockColors = {};
  const primaryColors = ["#d32f2f", "#1976d2", "#fbc02d"];
  let colorIndex = 0;
  let lastClickedMarker = null;
  let currentBlockFilter = "";
  let allCategories = new Set();
  const categoryColors = {
    "Total": "#1976d2",
    "PPC": "#d32f2f",
    "FPS": "#fbc02d",
    "Godown": "#388e3c",
    "Rice Mill": "#7b1fa2"
  };

  function getBlockColor(block) {
    if (!blockColors[block]) {
      blockColors[block] = primaryColors[colorIndex % primaryColors.length];
      colorIndex++;
    }
    return blockColors[block];
  }

  function getCategoryLetter(cat) {
    const catMap = { 
      "PPC": "P", 
      "Rice Mill": "M", 
      "FPS": "F", 
      "Godown": "G" 
    };
    return catMap[cat] || "?";
  }

  function getCategoryColor(category) {
    return categoryColors[category] || getRandomColor();
  }

  function getRandomColor() {
    const colors = ["#455a64", "#5d4037", "#00897b", "#d81b60", "#8e24aa", "#fb8c00"];
    return colors[Math.floor(Math.random() * colors.length)];
  }

  function linePin(color, scale = 1.1) {
    return {
      path: "M12 1C8.1 1 5 4.1 5 8.2c0 3.7 3.4 6.8 6 9.3V28h2V17.5c2.6-2.5 6-5.6 6-9.3C19 4.1 15.9 1 12 1z",
      fillColor: color,
      fillOpacity: 1,
      strokeColor: "#000",
      strokeWeight: 1,
      scale: scale,
      labelOrigin: new google.maps.Point(12, 9)
    };
  }

  function formatCoordinates(lat, lng) {
    return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
  }

  // Function to navigate to location - opens Google Maps directly without popup
  function navigateToLocation(lat, lng) {
    // Try to open Google Maps app
    window.location.href = `google.navigation:q=${lat},${lng}&mode=d`;
    
    // Fallback to web after a short delay if app doesn't open
    setTimeout(() => {
      window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`, '_blank');
    }, 500);
  }

  // Function to show share dialog with social media circles
  function showShareDialog(name, lat, lng) {
    const coordinates = formatCoordinates(lat, lng);
    const text = `üìç ${name}\nCoordinates: ${coordinates}\n\nView on Google Maps: https://maps.google.com/?q=${lat},${lng}`;
    const encodedText = encodeURIComponent(text);
    const mapsUrl = `https://maps.google.com/?q=${lat},${lng}`;
    
    // Remove any existing dialog
    const existingDialog = document.querySelector('.share-dialog-overlay');
    if (existingDialog) {
      existingDialog.remove();
    }
    
    // Create dialog overlay
    const overlay = document.createElement('div');
    overlay.className = 'share-dialog-overlay';
    
    // Create dialog content
    overlay.innerHTML = `
      <div class="share-dialog">
        <h3>Share Location</h3>
        <div class="location-name">${name}</div>
        <div class="coordinates">${coordinates}</div>
        
        <div class="social-icons">
          <a href="https://twitter.com/intent/tweet?text=${encodedText}" target="_blank" class="social-icon twitter" title="Share on Twitter">
            <i class="fab fa-twitter"></i>
          </a>
          <a href="https://www.facebook.com/sharer/sharer.php?u=${mapsUrl}&quote=${encodedText}" target="_blank" class="social-icon facebook" title="Share on Facebook">
            <i class="fab fa-facebook-f"></i>
          </a>
          <a href="https://wa.me/?text=${encodedText}" target="_blank" class="social-icon whatsapp" title="Share on WhatsApp">
            <i class="fab fa-whatsapp"></i>
          </a>
          <a href="https://t.me/share/url?url=${mapsUrl}&text=${encodedText}" target="_blank" class="social-icon telegram" title="Share on Telegram">
            <i class="fab fa-telegram-plane"></i>
          </a>
          <a href="#" class="social-icon copy" title="Copy to Clipboard" onclick="copyToClipboard('${text.replace(/'/g, "\\'")}'); return false;">
            <i class="fas fa-copy"></i>
          </a>
        </div>
        
        <button class="close-dialog-btn">Close</button>
      </div>
    `;
    
    document.body.appendChild(overlay);
    
    // Add close button functionality
    const closeBtn = overlay.querySelector('.close-dialog-btn');
    closeBtn.addEventListener('click', () => {
      overlay.remove();
    });
    
    // Close when clicking outside
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) {
        overlay.remove();
      }
    });
  }

  // Global copy function
  window.copyToClipboard = function(text) {
    navigator.clipboard.writeText(text).then(() => {
      // Show temporary success message
      const copyIcon = document.querySelector('.social-icon.copy i');
      if (copyIcon) {
        const originalClass = copyIcon.className;
        copyIcon.className = 'fas fa-check';
        setTimeout(() => {
          copyIcon.className = originalClass;
        }, 1500);
      }
      
      // Also show a small toast notification
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        z-index: 10000;
        animation: fadeInOut 1.5s ease;
      `;
      toast.textContent = 'Copied to clipboard!';
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 1500);
    }).catch(err => {
      alert('Failed to copy text');
    });
  };

  // Add animation style for toast
  const style = document.createElement('style');
  style.textContent = `
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translate(-50%, 20px); }
      15% { opacity: 1; transform: translate(-50%, 0); }
      85% { opacity: 1; transform: translate(-50%, 0); }
      100% { opacity: 0; transform: translate(-50%, -20px); }
    }
  `;
  document.head.appendChild(style);

  function resetLastMarker() {
    if (lastClickedMarker && lastClickedMarker.meta) {
      lastClickedMarker.setIcon(linePin(
        getBlockColor(lastClickedMarker.meta.block),
        1.1
      ));
      lastClickedMarker = null;
    }
  }

  function createCategoryElement(category, count) {
    const color = getCategoryColor(category);
    const span = document.createElement("span");
    span.style.fontWeight = "bold";
    span.style.color = color;
    span.innerHTML = `${category}: <span style="color: #333;">${count}</span>`;
    span.className = `category-${category.toLowerCase().replace(/\s+/g, '-')}`;
    return span;
  }

  function calculateBoundsForVisibleMarkers() {
    const bounds = new google.maps.LatLngBounds();
    let visibleCount = 0;
    
    markers.forEach(marker => {
      if (marker.getVisible()) {
        bounds.extend(marker.getPosition());
        visibleCount++;
      }
    });
    
    return { bounds, visibleCount };
  }

  function centerMapOnVisibleMarkers() {
    const { bounds, visibleCount } = calculateBoundsForVisibleMarkers();
    
    if (visibleCount === 0) {
      // If no markers are visible, reset to default view
      map.setCenter({ lat: 20.592263, lng: 83.248939 });
      map.setZoom(11);
    } else if (visibleCount === 1) {
      // If only one marker, center on it with zoom 14
      markers.forEach(marker => {
        if (marker.getVisible()) {
          map.setCenter(marker.getPosition());
          map.setZoom(14);
        }
      });
    } else {
      // If multiple markers, fit bounds with padding and minimum zoom
      const padding = 50; // pixels
      map.fitBounds(bounds, padding);
      
      // Set minimum zoom level to 12
      google.maps.event.addListenerOnce(map, 'bounds_changed', function() {
        if (map.getZoom() > 12) {
          map.setZoom(12);
        }
      });
      
      // Ensure zoom doesn't go below 12
      const currentZoom = map.getZoom();
      if (currentZoom < 12) {
        map.setZoom(12);
      }
    }
  }

  function updateLocationCounts() {
    // Count all markers that are currently visible (after filtering)
    let total = 0;
    const categoryCounts = {};
    
    // Initialize all known categories
    allCategories.forEach(category => {
      categoryCounts[category] = 0;
    });
    
    // Count visible markers
    markers.forEach(marker => {
      if (marker.getVisible()) {
        total++;
        const category = marker.meta.category || "Unknown";
        if (!categoryCounts[category]) {
          categoryCounts[category] = 0;
        }
        categoryCounts[category]++;
      }
    });
    
    // Update total count
    document.getElementById("totalCount").textContent = total;
    
    // Get the container for dynamic categories
    const categoriesContainer = document.querySelector("#locationCounts > div:first-child");
    
    // Keep the total count element and remove the rest
    const totalElement = categoriesContainer.children[0];
    categoriesContainer.innerHTML = '';
    categoriesContainer.appendChild(totalElement);
    
    // Add category counts (sorted alphabetically)
    Object.keys(categoryCounts)
      .filter(category => category !== "Total" && category !== "Unknown")
      .sort()
      .forEach(category => {
        if (categoryCounts[category] > 0) {
          const categoryElement = createCategoryElement(category, categoryCounts[category]);
          categoriesContainer.appendChild(categoryElement);
        }
      });
    
    // Add "Unknown" category if there are any
    if (categoryCounts["Unknown"] > 0) {
      const unknownElement = createCategoryElement("Unknown", categoryCounts["Unknown"]);
      categoriesContainer.appendChild(unknownElement);
    }
    
    // Update filter status
    const filterStatus = document.getElementById("filterStatus");
    if (currentBlockFilter) {
      filterStatus.textContent = `Showing locations for block: ${currentBlockFilter}`;
      filterStatus.title = `Filtered by: Block = "${currentBlockFilter}"`;
    } else {
      filterStatus.textContent = "Showing all locations";
      filterStatus.title = "No filters applied";
    }
  }

  function applyFilters() {
    const bV = document.getElementById("blockSearch").value.toUpperCase();
    const cV = document.getElementById("codeSearch").value.toUpperCase();
    const nV = document.getElementById("nameSearch").value.toUpperCase();
    
    currentBlockFilter = bV;

    markers.forEach(m => {
      const match = m.meta.block.includes(bV) && 
                    m.meta.code.includes(cV) && 
                    m.meta.name.includes(nV);
      m.setVisible(match);
      
      if (!match && lastClickedMarker === m) {
        resetLastMarker();
      }
    });
    
    updateLocationCounts();
    
    // Center map on visible markers (only if block filter is applied)
    if (bV) {
      setTimeout(() => {
        centerMapOnVisibleMarkers();
      }, 100); // Small delay to ensure markers are updated
    }
  }

  function initMap() {
    const mapEl = document.getElementById("map");
    if (!mapEl) return;

    map = new google.maps.Map(mapEl, {
      zoom: 11,
      center: { lat: 20.592263, lng: 83.248939 },
      gestureHandling: "greedy",
      mapTypeControl: false,
      fullscreenControl: true,
      streetViewControl: false,
      zoomControl: true,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    });

    const sheetURL = "https://docs.google.com/spreadsheets/d/1HI5Wjjwo5OObDaS4W7QaOVc_RcqgREu8pHEQxSjYhUg/gviz/tq?tqx=out:json";

    fetch(sheetURL)
      .then(res => res.text())
      .then(text => {
        const json = JSON.parse(text.substring(47).slice(0, -2));
        const rows = json.table.rows;
        const infoWindow = new google.maps.InfoWindow({
          maxWidth: 350,
          pixelOffset: new google.maps.Size(0, -30)
        });
        const blockSet = new Set();

        rows.forEach(r => {
          if (!r.c || !r.c[3] || !r.c[4]) return;

          const block = r.c[0]?.v || "Unknown";
          const name  = r.c[1]?.v || "No Name";
          const code  = r.c[2]?.v || "N/A";
          const lat   = parseFloat(r.c[3].v);
          const lng   = parseFloat(r.c[4].v);
          const cat   = r.c[5]?.v || "Unknown";

          blockSet.add(block);
          allCategories.add(cat);

          const marker = new google.maps.Marker({
            position: { lat, lng },
            map: map, 
            icon: linePin(getBlockColor(block)),
            label: { 
              text: getCategoryLetter(cat), 
              color: "white", 
              fontWeight: "bold", 
              fontSize: "11px" 
            },
            title: name,
            optimized: false
          });

          marker.meta = { 
            block: block.toUpperCase(), 
            code: String(code).toUpperCase(), 
            name: name.toUpperCase(),
            lat: lat,
            lng: lng,
            category: cat
          };

          google.maps.event.addListener(marker, 'click', function(e) {
            e.stop();
            resetLastMarker();
            lastClickedMarker = marker;
            marker.setIcon(linePin(getBlockColor(block), 1.5));
            
            const content = `
              <div style="min-width: 220px; max-width: 300px;">
                <h3 style="margin: 0 0 8px 0; color: #1976d2; font-size: 16px;">${name}</h3>
                <div style="margin-bottom: 5px; font-size: 13px;"><strong>Code:</strong> ${code}</div>
                <div style="margin-bottom: 5px; font-size: 13px;"><strong>Block:</strong> ${block}</div>
                <div style="margin-bottom: 5px; font-size: 13px;"><strong>Category:</strong> ${cat}</div>
                <div style="margin-bottom: 10px; padding: 8px; background: #f5f5f5; border-radius: 4px; font-family: monospace; font-size: 12px;">
                  <strong>Coordinates:</strong><br>
                  ${formatCoordinates(lat, lng)}
                </div>
                
                <div class="info-window-buttons">
                  <button onclick="window.showShareDialog('${name.replace(/'/g, "\\'")}', ${lat}, ${lng})" class="info-window-btn share-btn" title="Share location">
                    <i class="fas fa-share-alt"></i>
                  </button>
                  <button onclick="window.navigateToLocation(${lat}, ${lng})" class="info-window-btn navigate-btn" title="Navigate to location">
                    <i class="fas fa-directions"></i>
                  </button>
                </div>
              </div>
            `;
            
            infoWindow.setContent(content);
            infoWindow.open(map, marker);
          });

          markers.push(marker);
        });

        // Make functions globally accessible
        window.showShareDialog = showShareDialog;
        window.navigateToLocation = navigateToLocation;

        map.addListener("click", () => {
          infoWindow.close();
          resetLastMarker();
        });

        // Populate block list
        const list = document.getElementById("blockList");
        [...blockSet].sort().forEach(b => {
          const opt = document.createElement("option");
          opt.value = b;
          list.appendChild(opt);
        });

        // Initial update of location counts
        updateLocationCounts();
      })
      .catch(error => {
        console.error('Error loading spreadsheet data:', error);
        // Show user-friendly error message
        document.getElementById('map').innerHTML = `
          <div style="padding: 20px; text-align: center; color: #721c24; background: #f8d7da; border-radius: 8px;">
            Failed to load location data. Please refresh the page or try again later.
          </div>
        `;
      });

    // Filtering Logic
    const filters = ["blockSearch", "codeSearch", "nameSearch"];
    filters.forEach(id => {
      const input = document.getElementById(id);
      
      input.addEventListener("input", () => {
        applyFilters();
      });
    });
    
    // Clear filters with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        document.getElementById("blockSearch").value = '';
        document.getElementById("codeSearch").value = '';
        document.getElementById("nameSearch").value = '';
        currentBlockFilter = '';
        
        markers.forEach(m => {
          m.setVisible(true);
        });
        
        updateLocationCounts();
        
        // Reset map to default view
        map.setCenter({ lat: 20.592263, lng: 83.248939 });
        map.setZoom(11);
      }
    });
    
    // Add "Show All" button dynamically
    const mapControls = document.querySelector('.map-controls');
    const showAllButton = document.createElement('button');
    showAllButton.textContent = 'Show All';
    showAllButton.title = 'Reset all filters and show all locations';
    showAllButton.addEventListener('mouseenter', function() {
      this.style.background = '#1565c0';
    });
    showAllButton.addEventListener('mouseleave', function() {
      this.style.background = '#1976d2';
    });
    showAllButton.addEventListener('click', function() {
      document.getElementById("blockSearch").value = '';
      document.getElementById("codeSearch").value = '';
      document.getElementById("nameSearch").value = '';
      currentBlockFilter = '';
      
      markers.forEach(m => {
        m.setVisible(true);
      });
      
      updateLocationCounts();
      
      // Reset map to default view
      map.setCenter({ lat: 20.592263, lng: 83.248939 });
      map.setZoom(11);
    });
    
    mapControls.appendChild(showAllButton);
  }

  // Initialize map when DOM is ready
  if (document.readyState === "complete" || document.readyState === "interactive") {
    setTimeout(initMap, 100); // Small delay to ensure DOM is fully ready
  } else {
    window.addEventListener("load", initMap);
  }
})();
</script>
<!-- FOOTER -->
<div id="site-footer"></div>
  <!-- Go to Top -->
  <script src="/assets/Scripts/gototop.js"></script>
</body>
</html>
