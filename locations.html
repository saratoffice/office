<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sarat Office | Work Place Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f8f9fa;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #2c3e50, #4a6491);
      color: white;
      padding: 20px 30px;
      border-bottom: 3px solid #3498db;
    }
    
    .header h1 {
      margin: 0;
      font-size: 1.8rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .header h1:before {
      content: "üìç";
      font-size: 1.5rem;
    }
    
    .header p {
      margin: 5px 0 0 0;
      opacity: 0.9;
      font-size: 0.95rem;
    }
    
    /* Controls */
    .map-controls {
      padding: 20px 30px;
      background: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .control-group label {
      font-size: 0.85rem;
      color: #555;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .control-group label:before {
      font-size: 1rem;
    }
    
    #blockSearch-label:before { content: "üó∫Ô∏è"; }
    #codeSearch-label:before { content: "üè∑Ô∏è"; }
    #nameSearch-label:before { content: "üè¢"; }
    
    .map-controls input {
      padding: 12px 15px;
      font-size: 0.95rem;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      background: white;
      transition: all 0.3s ease;
      width: 100%;
    }
    
    .map-controls input:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    
    /* Map */
    #map {
      width: 100%;
      height: 600px;
    }
    
    /* Legend */
    .legend {
      padding: 15px 30px;
      background: white;
      border-top: 1px solid #e9ecef;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: center;
    }
    
    .legend-title {
      font-weight: 600;
      color: #2c3e50;
    }
    
    .legend-items {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    
    /* Stats */
    .stats {
      padding: 15px 30px;
      background: #2c3e50;
      color: white;
      display: flex;
      flex-wrap: wrap;
      gap: 25px;
    }
    
    .stat-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .stat-value {
      font-weight: bold;
      color: #3498db;
      font-size: 1.1rem;
    }
    
    /* Loading & Error */
    #loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      transition: opacity 0.3s ease;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error-message {
      background: #ffe6e6;
      color: #d63031;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #d63031;
      margin: 20px;
      display: none;
    }
    
    .error-message h3 {
      margin-top: 0;
    }
    
    .error-message a {
      color: #3498db;
      text-decoration: none;
      font-weight: bold;
    }
    
    .error-message a:hover {
      text-decoration: underline;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .map-controls {
        grid-template-columns: 1fr;
        padding: 15px;
      }
      
      #map {
        height: 500px;
      }
      
      .stats {
        justify-content: center;
      }
    }
    
    /* Custom marker cluster styles */
    .cluster {
      background: #3498db;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      border: 3px solid white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      font-family: inherit;
    }
    
    .cluster-small { width: 40px; height: 40px; font-size: 14px; }
    .cluster-medium { width: 50px; height: 50px; font-size: 16px; background: #2980b9; }
    .cluster-large { width: 60px; height: 60px; font-size: 18px; background: #1c5a80; }
  </style>
</head>

<body>
  <!-- Loading Screen -->
  <div id="loading">
    <div class="spinner"></div>
    <h3>Loading Map...</h3>
    <p>Please wait while we load your locations</p>
  </div>
  
  <!-- Error Message -->
  <div class="error-message" id="errorMessage"></div>
  
  <div class="container">
    <header class="header">
      <h1>Sarat Office - Work Place Map</h1>
      <p>Interactive map of all workplace locations with filtering capabilities</p>
    </header>
    
    <div class="map-controls">
      <div class="control-group">
        <label id="blockSearch-label" for="blockSearch">Block / Area</label>
        <input id="blockSearch" list="blockList" type="text" placeholder="Type or select block name" />
        <datalist id="blockList"></datalist>
      </div>
      
      <div class="control-group">
        <label id="codeSearch-label" for="codeSearch">Workplace Code</label>
        <input id="codeSearch" type="text" placeholder="Search by workplace code" />
      </div>
      
      <div class="control-group">
        <label id="nameSearch-label" for="nameSearch">Workplace Name</label>
        <input id="nameSearch" type="text" placeholder="Search by workplace name" />
      </div>
    </div>
    
    <div id="map"></div>
    
    <div class="legend">
      <div class="legend-title">Block Colors:</div>
      <div class="legend-items" id="legendItems">
        <!-- Dynamically populated -->
      </div>
    </div>
    
    <div class="stats">
      <div class="stat-item">
        <span>üìç Total Locations:</span>
        <span class="stat-value" id="totalLocations">0</span>
      </div>
      <div class="stat-item">
        <span>üëÅÔ∏è Visible:</span>
        <span class="stat-value" id="visibleLocations">0</span>
      </div>
      <div class="stat-item">
        <span>üé® Blocks:</span>
        <span class="stat-value" id="blockCount">0</span>
      </div>
    </div>
  </div>

  <!-- IMPORTANT: REPLACE WITH YOUR GOOGLE MAPS API KEY -->
  <script>
    // Configuration
    const CONFIG = {
      // ‚ö†Ô∏è REPLACE THIS WITH YOUR ACTUAL GOOGLE MAPS API KEY ‚ö†Ô∏è
      GOOGLE_MAPS_API_KEY: 'AIzaSyBg1u41idNFQLOTM2tUR3R2tYdLou2X9Ys',
      
      // Google Sheets URL (no changes needed)
      SHEET_URL: 'https://docs.google.com/spreadsheets/d/1HI5Wjjwo5OObDaS4W7QaOVc_RcqgREu8pHEQxSjYhUg/gviz/tq?tqx=out:json',
      
      // Initial map center (Bolangir, Odisha)
      MAP_CENTER: { lat: 20.97, lng: 83.53 },
      MAP_ZOOM: 11
    };
    
    // Show error if API key is not set
    if (!CONFIG.GOOGLE_MAPS_API_KEY || CONFIG.GOOGLE_MAPS_API_KEY === 'AIzaSyBg1u41idNFQLOTM2tUR3R2tYdLou2X9Ys') {
      document.getElementById('loading').innerHTML = `
        <div class="error-message" style="display: block; max-width: 600px;">
          <h3>‚ö†Ô∏è Google Maps API Key Required</h3>
          <p>To use this map on GitHub Pages, you need to:</p>
          <ol style="margin: 10px 0 10px 20px;">
            <li>Get a free API key from <a href="https://developers.google.com/maps/documentation/javascript/get-api-key" target="_blank">Google Cloud Console</a></li>
            <li>Enable "Maps JavaScript API" for your project</li>
            <li>Add billing information (first $200/month is free)</li>
            <li>Replace <code>AIzaSyBg1u41idNFQLOTM2tUR3R2tYdLou2X9Ys</code> in the code with your actual key</li>
            <li>Restrict the API key to your GitHub Pages domain</li>
          </ol>
          <p><strong>Or use the OpenStreetMap version</strong> (no API key needed) by copying the code from the previous response.</p>
        </div>
      `;
      throw new Error('Google Maps API key not configured');
    }
  </script>
  
  <!-- Load Google Maps API with your key -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBg1u41idNFQLOTM2tUR3R2tYdLou2X9Ys&callback=initMap" async defer></script>
  
  <!-- Marker Clusterer -->
  <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

  <script>
    // Global variables
    let map;
    let markers = [];
    let markerCluster;
    let infoWindow;
    
    // Color management
    const blockColors = {};
    const primaryColors = ["#d32f2f", "#1976d2", "#fbc02d", "#388e3c", "#7b1fa2", "#f57c00"];
    let colorIndex = 0;
    
    // Get color for a block
    function getBlockColor(block) {
      if (!blockColors[block]) {
        blockColors[block] = primaryColors[colorIndex % primaryColors.length];
        colorIndex++;
      }
      return blockColors[block];
    }
    
    // Get category letter
    function getCategoryLetter(cat) {
      if (!cat) return "?";
      if (cat.includes("PPC")) return "P";
      if (cat.includes("Rice") || cat.includes("Mill")) return "M";
      if (cat.includes("FPS")) return "F";
      if (cat.includes("Godown")) return "G";
      return cat.charAt(0).toUpperCase();
    }
    
    // Custom pin icon
    function createPinIcon(color) {
      return {
        path: google.maps.SymbolPath.CIRCLE,
        fillColor: color,
        fillOpacity: 0.9,
        strokeColor: "#000",
        strokeWeight: 1.5,
        scale: 10,
        labelOrigin: new google.maps.Point(0, 0)
      };
    }
    
    // Initialize map
    function initMap() {
      try {
        // Hide loading screen
        document.getElementById('loading').style.opacity = '0';
        setTimeout(() => {
          document.getElementById('loading').style.display = 'none';
        }, 300);
        
        // Create map
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: CONFIG.MAP_ZOOM,
          center: CONFIG.MAP_CENTER,
          gestureHandling: "greedy",
          fullscreenControl: true,
          mapTypeControl: true,
          streetViewControl: true,
          zoomControl: true,
          styles: [
            {
              featureType: "poi.business",
              stylers: [{ visibility: "off" }]
            },
            {
              featureType: "transit",
              elementType: "labels.icon",
              stylers: [{ visibility: "off" }]
            }
          ]
        });
        
        infoWindow = new google.maps.InfoWindow({
          maxWidth: 300
        });
        
        // Load data from Google Sheets
        loadSheetData();
        
      } catch (error) {
        showError('Failed to initialize map: ' + error.message);
      }
    }
    
    // Load data from Google Sheets
    async function loadSheetData() {
      try {
        const response = await fetch(CONFIG.SHEET_URL);
        const text = await response.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));
        const rows = json.table.rows;
        
        const blockSet = new Set();
        markers = [];
        
        // Process each row
        rows.forEach((r, index) => {
          if (!r.c || !r.c[3]?.v || !r.c[4]?.v) return;
          
          const block = (r.c[0]?.v || "Unknown").trim();
          const name = (r.c[1]?.v || "Unnamed").trim();
          const code = (r.c[2]?.v || "N/A").trim();
          const lat = parseFloat(r.c[3].v);
          const lng = parseFloat(r.c[4].v);
          const cat = (r.c[5]?.v || "Other").trim();
          
          if (isNaN(lat) || isNaN(lng)) return;
          
          blockSet.add(block);
          
          const markerColor = getBlockColor(block);
          
          const marker = new google.maps.Marker({
            position: { lat, lng },
            map: map,
            icon: createPinIcon(markerColor),
            label: {
              text: getCategoryLetter(cat),
              color: "white",
              fontWeight: "bold",
              fontSize: "11px"
            },
            title: `${name} (${code})`,
            animation: google.maps.Animation.DROP
          });
          
          // Store metadata for filtering
          marker.meta = {
            block: block.toUpperCase(),
            name: name.toUpperCase(),
            code: code.toUpperCase(),
            category: cat,
            color: markerColor
          };
          
          // Add click listener
          marker.addListener("click", () => {
            infoWindow.setContent(`
              <div style="padding: 10px; min-width: 200px;">
                <h3 style="margin: 0 0 10px 0; color: #2c3e50;">${name}</h3>
                <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                  <p style="margin: 5px 0;"><strong>Code:</strong> ${code}</p>
                  <p style="margin: 5px 0;"><strong>Block:</strong> ${block}</p>
                  <p style="margin: 5px 0;"><strong>Category:</strong> ${cat}</p>
                </div>
                <div style="color: #666; font-size: 0.9em;">
                  <p style="margin: 5px 0;">Coordinates: ${lat.toFixed(4)}, ${lng.toFixed(4)}</p>
                  <p style="margin: 5px 0;">Click on map to close</p>
                </div>
              </div>
            `);
            infoWindow.open(map, marker);
          });
          
          markers.push(marker);
        });
        
        // Create marker cluster
        markerCluster = new markerClusterer.MarkerClusterer({
          map,
          markers,
          renderer: {
            render: ({ count, position }) => {
              // Custom cluster icon
              const size = count < 10 ? 'small' : count < 50 ? 'medium' : 'large';
              return new google.maps.Marker({
                position,
                icon: {
                  url: `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(`
                    <svg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="30" cy="30" r="25" fill="#3498db" stroke="white" stroke-width="3"/>
                      <text x="30" y="35" text-anchor="middle" fill="white" font-family="Arial, sans-serif" font-weight="bold" font-size="18">${count}</text>
                    </svg>
                  `)}`,
                  scaledSize: new google.maps.Size(40, 40),
                  anchor: new google.maps.Point(20, 20)
                },
                label: null
              });
            }
          }
        });
        
        // Populate filters and update UI
        populateBlockList(blockSet);
        updateLegend();
        updateStatistics();
        
        // Fit bounds to show all markers
        if (markers.length > 0) {
          const bounds = new google.maps.LatLngBounds();
          markers.forEach(marker => bounds.extend(marker.getPosition()));
          map.fitBounds(bounds, { padding: 50 });
        }
        
      } catch (error) {
        console.error('Error loading data:', error);
        showError('Failed to load location data. Please check your Google Sheets URL.');
      }
    }
    
    // Populate block dropdown
    function populateBlockList(blockSet) {
      const list = document.getElementById("blockList");
      list.innerHTML = "";
      const sortedBlocks = [...blockSet].sort();
      
      sortedBlocks.forEach(block => {
        const opt = document.createElement("option");
        opt.value = block;
        list.appendChild(opt);
      });
      
      document.getElementById('blockCount').textContent = sortedBlocks.length;
    }
    
    // Update legend
    function updateLegend() {
      const legendItems = document.getElementById('legendItems');
      legendItems.innerHTML = '';
      
      Object.keys(blockColors).sort().forEach(block => {
        const item = document.createElement('div');
        item.className = 'legend-item';
        item.innerHTML = `
          <div class="legend-color" style="background: ${blockColors[block]};"></div>
          <span>${block}</span>
        `;
        legendItems.appendChild(item);
      });
    }
    
    // Update statistics
    function updateStatistics() {
      document.getElementById('totalLocations').textContent = markers.length;
      updateVisibleCount();
    }
    
    // Update visible count
    function updateVisibleCount() {
      const visible = markers.filter(m => m.getVisible()).length;
      document.getElementById('visibleLocations').textContent = visible;
    }
    
    // Apply filters
    function applyFilters() {
      const blockVal = document.getElementById('blockSearch').value.trim().toUpperCase();
      const codeVal = document.getElementById('codeSearch').value.trim().toUpperCase();
      const nameVal = document.getElementById('nameSearch').value.trim().toUpperCase();
      
      markers.forEach(marker => {
        const meta = marker.meta;
        const blockMatch = !blockVal || meta.block.includes(blockVal);
        const codeMatch = !codeVal || meta.code.includes(codeVal);
        const nameMatch = !nameVal || meta.name.includes(nameVal);
        
        marker.setVisible(blockMatch && codeMatch && nameMatch);
      });
      
      // Update marker clusters
      if (markerCluster) {
        markerCluster.repaint();
      }
      
      updateVisibleCount();
    }
    
    // Show error message
    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.innerHTML = `<h3>Error</h3><p>${message}</p>`;
      errorDiv.style.display = 'block';
      
      // Hide loading screen
      document.getElementById('loading').style.display = 'none';
    }
    
    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      // Setup filter event listeners
      document.getElementById('blockSearch').addEventListener('input', applyFilters);
      document.getElementById('codeSearch').addEventListener('input', applyFilters);
      document.getElementById('nameSearch').addEventListener('input', applyFilters);
      
      // Close info window when clicking on map
      google.maps.event.addListener(map, 'click', function() {
        infoWindow.close();
      });
    });
    
    // Handle Google Maps API errors
    window.gm_authFailure = function() {
      showError('Google Maps authentication failed. Please check your API key.');
    };
  </script>
</body>
</html>
